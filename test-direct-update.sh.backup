#!/usr/bin/env bash

# Test what happens when a script tries to update itself directly

set -euo pipefail

VERSION="1.0"

show_version() {
    echo "Current version: $VERSION"
    echo "Script path: $0"
    echo "PID: $$"
}

# Attempt direct self-update (this typically fails)
direct_update() {
    echo "=== Attempting direct self-update ==="
    
    local script_path="$(realpath "$0")"
    local backup_path="${script_path}.backup"
    
    echo "Current script: $script_path"
    echo "Creating backup..."
    cp "$script_path" "$backup_path"
    
    echo "Attempting to overwrite running script..."
    
    # Try to create new content and overwrite
    cat > "${script_path}.tmp" << 'EOF'
#!/usr/bin/env bash
set -euo pipefail
VERSION="2.0"
show_version() {
    echo "Current version: $VERSION"
    echo "Script path: $0"
    echo "PID: $$"
}
echo "=== Updated Script ==="
show_version
echo "Update was successful!"
EOF
    
    # Attempt to move new file over running script
    echo "Moving new version over current script..."
    mv -f "${script_path}.tmp" "$script_path" 2>&1 || echo "Move failed: $?"
    
    # Try to modify permissions
    chmod +x "$script_path" 2>&1 || echo "Chmod failed: $?"
    
    echo "Direct update attempt completed"
    echo "Continuing execution..."
    
    # See if we can still execute
    show_version
    echo "Script is still running!"
}

echo "=== Direct Update Test Script ==="
show_version
echo ""

read -p "Press Enter to attempt direct update: "
direct_update